{
  "variables": {
    "ami_version": "2017.1",
    "aws_access_key": "",
    "aws_secret_key": "",
    "vsi_version": "2017.1",
    "vsi_version_min": "_1.0",
    "svi_s3": "https://s3.amazonaws.com/systemview",
    "nx_img": "nomachine_5.2.21_1_x86_64.rpm",
    "vsi_rel_type": "release",
	"vivado_name": "Xilinx_Vivado_SDK_",
    "vivado_version": "2017.1",
    "vivado_version_min": "_0415_1",
	"vivado_tar_ext": ".tar.gz",
	"vivado_tar_flag": "xz",
	"vivado_install_config": "vivado_install_config.txt"
  },
  "builders": [{
    "type": "amazon-ebs",
    "access_key": "{{user `aws_access_key`}}",
    "secret_key": "{{user `aws_secret_key`}}",
    "region": "us-east-1",
    "source_ami": "ami-ae7bfdb8",
    "instance_type": "t2.2xlarge",
    "ssh_username": "centos",
    "ami_name": "Visual System Integrator {{user `vsi_version`}}{{user `vsi_version_min`}} ami {{user `ami_version`}}",
    "ami_product_codes": "",
    "ami_block_device_mappings": [{
      "device_name": "/dev/sda1",
      "volume_size": 150,
      "volume_type": "gp2",
      "delete_on_termination": true
    },{
      "device_name": "/dev/sdb1",
      "volume_size": 5,
      "volume_type": "gp2",
      "delete_on_termination": false
    }],
    "launch_block_device_mappings": [{
      "device_name": "/dev/sda1",
      "volume_size": 150,
      "volume_type": "gp2",
      "delete_on_termination": true
    }]
  }],
  "provisioners": [{
    "type": "shell",
    "inline": [
      "sleep 30",
      "echo \"===>Updating message of the day<===\"",
      "echo \"__   _____ ___   ___ ___  ___   _     ___  _____   __    _   __  __ ___\" > /tmp/motd",
      "echo \"\\ \\ / / __|_ _| | __| _ \\/ __| /_\\   |   \\| __\\ \\ / /   /_\\ |  \\/  |_ _|\" >> /tmp/motd",
      "echo \" \\ V /\\__ \\| |  | _||  _/ (_ |/ _ \\  | |) | _| \\ V /   / _ \\| |\\/| || |\" >> /tmp/motd",
      "echo \"  \\_/ |___/___| |_| |_|  \\___/_/ \\_\\ |___/|___| \\_/   /_/ \\_\\_|  |_|___|\" >> /tmp/motd",
      "echo >> /tmp/motd",
      "echo \"AMI Version:                   {{user `vsi_version`}}{{user `vsi_version_min`}}\" >> /tmp/motd",
      "echo \"SystemView Root:               /opt/Systemview\" >> /tmp/motd",
      "echo \"Xilinx Tools:                  /opt/Xilinx\" >> /tmp/motd",
      "echo \"SystemView AMI Developer Support:  https://systemviewinc.com/amazon-aws-f1/\" >> /tmp/motd",
      "echo \"Visual System Integrator Documentation:  http://docs.systemviewinc.com\" >> /tmp/motd",
      "echo \"AWS F1 Developer Support:         https://github.com/aws/aws-fpga/blob/master/README.md#developer-support\" >> /tmp/motd",
      "echo \"Centos Readme:                        /home/centos/src/README.md\" >> /tmp/motd",
      "sudo mv /tmp/motd /etc/motd",

      "echo \"===>Adding epel repository<===\"",
      "sudo yum -y install epel-release deltarpm centos-release-scl",
      "sudo yum -y update",

      "echo \"===>installing GCC 6 tools <===\"",
      "sudo yum install -y devtoolset-6-gcc*",
      "echo source scl_source enable devtoolset-6 >> ~/.bashrc",

      "echo \"===>installing utils and display tools <===\"",
      "sudo yum install -y fish wget python-pip python-wheel bzip2",
      "sudo yum groupinstall -y \"x window system\"",
      "sudo yum groupinstall -y xfce",

      "mkdir -p ~/.config/xfce4/terminal && echo [Configuration] >> ~/.config/xfce4/terminal/terminalrc && echo \"FontName=DejaVu Sans Mono 10\" >> ~/.config/xfce4/terminal/terminalrc",

      "wget -q {{user `svi_s3`}}/files/thirdparty/{{user `nx_img`}} && sudo rpm -i ~/{{user `nx_img`}} && rm ~/{{user `nx_img`}}",
      "mkdir -p ~/.nx/config && cd ~/.nx/config && ln -s ../../.ssh/authorized_keys authorized.crt && cd ~/",

      "sudo pip install --upgrade awscli",

      "export VIVADO_FILE={{user `vivado_name`}}{{user `vivado_version`}}{{user `vivado_version_min`}}",
      "echo \"===> Downloading and extracting Vivado image from {{user `svi_s3`}}/files/thirdparty/${VIVADO_FILE}{{user `vivado_tar_ext`}} <===\"",
      "wget -q {{user `svi_s3`}}/files/thirdparty/{{user `vivado_install_config`}}",
      "wget -qO- {{user `svi_s3`}}/files/thirdparty/${VIVADO_FILE}{{user `vivado_tar_ext`}} | tar {{user `vivado_tar_flag`}}",
      "echo \"===> Installing Vivado <===\"",
      "sudo bash ${VIVADO_FILE}/xsetup --agree 3rdPartyEULA,WebTalkTerms,XilinxEULA -b Install -c {{user `vivado_install_config`}}",
      "echo \"===> Vivado Installation Completed <===\"",
      "rm -rf ${VIVADO_FILE}* {{user `vivado_install_config`}}",
      "echo export VIVADO_ROOT=/opt/Xilinx >> ~/.bashrc",
      "echo export VIVADO_VERSION={{user `vivado_version`}} >> ~/.bashrc",

      "export VSI_INSTALL_IMG=systemview_vsi_{{user `vsi_version`}}{{user `vsi_version_min`}}.tar.bz2",
      "export VSI_INSTALL=/opt/Systemview/VSI/{{user `vsi_version`}}",
      "wget -q {{user `svi_s3`}}/files/{{user `vsi_rel_type`}}/${VSI_INSTALL_IMG} && sudo mkdir -p ${VSI_INSTALL} && cd ${VSI_INSTALL} && sudo tar xf ~/${VSI_INSTALL_IMG} && rm ~/${VSI_INSTALL_IMG}",
      "echo export VSI_INSTALL=${VSI_INSTALL} >> ~/.bashrc",

      "echo export PATH=\\$PATH:\\${VSI_INSTALL}/host/linux.x86_64/bin:\\${VIVADO_ROOT}/Vivado/\\${VIVADO_VERSION}/bin:\\${VIVADO_ROOT}/SDK/\\${VIVADO_VERSION}/bin:\\${VIVADO_ROOT}/SDK/\\${VIVADO_VERSION}/gnu/microblaze/lin/bin:\\${VIVADO_ROOT}/SDK/\\${VIVADO_VERSION}/gnu/arm/lin/bin:\\${VIVADO_ROOT}/SDK/\\${VIVADO_VERSION}/gnu/microblaze/linux_toolchain/lin64_le/bin:\\${VIVADO_ROOT}/SDK/\\${VIVADO_VERSION}/gnu/aarch32/lin/gcc-arm-linux-gnueabi/bin:\\${VIVADO_ROOT}/SDK/\\${VIVADO_VERSION}/gnu/aarch32/lin/gcc-arm-none-eabi/bin:\\${VIVADO_ROOT}/SDK/\\${VIVADO_VERSION}/gnu/aarch64/lin/aarch64-linux/bin:\\${VIVADO_ROOT}/SDK/\\${VIVADO_VERSION}/gnu/aarch64/lin/aarch64-none/bin:\\${VIVADO_ROOT}/SDK/\\${VIVADO_VERSION}/gnu/armr5/lin/gcc-arm-none-eabi/bin:\\${VIVADO_ROOT}/SDK/\\${VIVADO_VERSION}/tps/lnx64/cmake-3.3.2/bin >> ~/.bashrc",
	  "echo if [ ! -d ~/aws-fpga ]; then echo Cloning Aws-Fpga CL Repo. Please wait...; git clone https://github.com/systemviewinc/aws-fpga ~/aws-fpga; fi",
      "echo export CL_DIR=/home/centos/aws-fpga/hdk/cl/vsi_cl/ >> ~/.bashrc",
      "echo source /home/centos/aws-fpga/hdk_setup.sh >> ~/.bashrc",
      "mkdir -p ~/.Xilinx/Vivado && cd ~/.Xilinx/Vivado && ln -s Vivado_init.tcl init.tcl"
    ]
  }]
}
